<?xml version="1.0" encoding="utf-8"?>

<!--
  Copyright (C) 2011-2013 Xtensive LLC.
  All rights reserved.
  For conditions of distribution and use, see license.
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

<PropertyGroup>
  <!-- Register weaving target for execution after compilation -->
  <CompileDependsOn>$(CompileDependsOn);XtensiveOrmRunWeaver</CompileDependsOn>
  <!-- Autodetect weaver program unless overridden by user -->
  <XtensiveOrmWeaver Condition="'$(XtensiveOrmWeaver)'==''">$(MSBuildThisFileDirectory)\Tools\Weaver.exe</XtensiveOrmWeaver>
  <XtensiveOrmRunWeaverDependsOn>$(XtensiveOrmRunWeaverDependsOn)</XtensiveOrmRunWeaverDependsOn>
</PropertyGroup>

<!-- Run weaver -->
<Target Name="XtensiveOrmRunWeaver"
        Inputs="@(IntermediateAssembly -> '%(FullPath)')"
        Outputs="@(IntermediateAssembly -> '%(FullPath).weaver-stamp')"
        DependsOnTargets="ResolveAssemblyReferences;_CopyFilesMarkedCopyLocal;$(XtensiveOrmRunWeaverDependsOn)">
  <Error Condition="!Exists('$(XtensiveOrmWeaver)')"
         Text="Weaver is not found at '$(XtensiveOrmWeaver)'" />
  <Message Importance="low" Text="Using weaver at '$(XtensiveOrmWeaver)'"/>
  <PropertyGroup>
    <XtensiveOrmWeaverParameters>/input:"@(IntermediateAssembly -> '%(FullPath)')" /makeBackup:true /writeStampFile:true</XtensiveOrmWeaverParameters>
    <XtensiveOrmWeaverParameters Condition="'$(DebugSymbols)'=='true'">$(XtensiveOrmWeaverParameters) /processDebugSymbols:true</XtensiveOrmWeaverParameters>
    <XtensiveOrmWeaverParameters Condition="$(SignAssembly)=='true'">$(XtensiveOrmWeaverParameters) /strongNameKey:"$(AssemblyOriginatorKeyFile)"</XtensiveOrmWeaverParameters>
    <XtensiveOrmWeaverParameters>$(XtensiveOrmWeaverParameters) @(ReferencePath -> '/reference:"%(FullPath)"', ' ')</XtensiveOrmWeaverParameters>
  </PropertyGroup>
  <Exec Command="$(XtensiveOrmWeaver) $(XtensiveOrmWeaverParameters)"
        WorkingDirectory="$(MSBuildProjectDirectory)"
        IgnoreExitCode="true">
    <Output TaskParameter="ExitCode" PropertyName="XtensiveOrmWeaverResult" />        
  </Exec>
</Target>

</Project>
