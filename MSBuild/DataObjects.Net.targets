<?xml version="1.0" encoding="utf-8"?>

<!--
  Copyright (C) 2011-2012 Xtensive LLC.
  All rights reserved.
  For conditions of distribution and use, see license.
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

<PropertyGroup>
  <!-- Register configuration target for execution before PostSharp -->
  <PostSharp21DependsOn>$(PostSharp21DependsOn);RegisterXtensiveAspectsWeaver</PostSharp21DependsOn>
  
  <!-- Autodetect root folder (requires MSBuild 4.0 or later) -->
  <XtensiveOrmPath Condition="'$(XtensiveOrmPath)'==''">$(MSBuildThisFileDirectory)</XtensiveOrmPath>
  
  <!-- Enable integrated PostSharp unless explicitly disabled by user -->
  <XtensiveOrmIntegratedPostSharp Condition="'$(XtensiveOrmIntegratedPostSharp)'==''">true</XtensiveOrmIntegratedPostSharp>
</PropertyGroup>

<!-- Autodetect root folder by inspecting reference to Xtensive.Aspects
     This works only if MSBuild 3.5 is used and user did not provide that path -->
<Target Name="DetectXtensiveOrmPath"
        DependsOnTargets="ResolveAssemblyReferences"
        Condition="'$(XtensiveOrmPath)'==''">
  <CreateProperty
    Condition="'%(ReferencePath.FileName)'=='Xtensive.Aspects'"
    Value="%(ReferencePath.RootDir)%(ReferencePath.Directory)">
    <Output TaskParameter="Value" PropertyName="XtensiveAspectsReferencePath" />
  </CreateProperty>
  <Message Condition="Exists('$(XtensiveAspectsReferencePath)')"
           Importance="low"
           Text="Found Xtensive.Aspects.dll in '$(XtensiveAspectsReferencePath)'" />
  <PropertyGroup>
    <XtensiveOrmPath Condition="Exists('$(XtensiveAspectsReferencePath)')">$(XtensiveAspectsReferencePath)..\..\</XtensiveOrmPath>
  </PropertyGroup>
</Target>

<!-- Validate that root path is set optionally triggering detection target -->
<Target Name="ValidateXtensiveOrmPath" DependsOnTargets="DetectXtensiveOrmPath">
  <Error Condition="'$(XtensiveOrmPath)'==''"
         Text="XtensiveOrmPath property is not set" />
  <Error Condition="!Exists('$(XtensiveOrmPath)')"
         Text="XtensiveOrmPath is set to '$(XtensiveOrmPath)' which does not exists" />
  <PropertyGroup>
    <XtensiveOrmPath Condition="!HasTrailingSlash('$(XtensiveOrmPath)')">$(XtensiveOrmPath)\</XtensiveOrmPath>
  </PropertyGroup>
  <Message Importance="low" Text="Using XtensiveOrmPath = '$(XtensiveOrmPath)'"/>
</Target>

<!-- Add tools folder to PostSharp plugin search path path -->
<Target Name="RegisterXtensiveAspectsWeaver" DependsOnTargets="ValidateXtensiveOrmPath">
  <PropertyGroup>
    <XtensiveAspectsWeaverPath>$(XtensiveOrmPath)Tools</XtensiveAspectsWeaverPath>
    <PostSharpSearchPath>$(PostSharpSearchPath);$(XtensiveAspectsWeaverPath)</PostSharpSearchPath>
  </PropertyGroup>
  <Message Importance="low" Text="Added '$(XtensiveAspectsWeaverPath)' to PostSharpSearchPath"/>
</Target>

<!-- Import integrated PostSharp if required -->
<Import Condition="'$(XtensiveOrmIntegratedPostSharp)'=='true'"
        Project="Tools\PostSharp\PostSharp.targets" />

</Project>
