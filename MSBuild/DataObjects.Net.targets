<?xml version="1.0" encoding="utf-8"?>

<!--
  Copyright (C) 2011-2013 Xtensive LLC.
  All rights reserved.
  For conditions of distribution and use, see license.
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

<PropertyGroup>
  <!-- Register configuration target for execution before PostSharp -->
  <PostSharp21DependsOn>$(PostSharp21DependsOn);RegisterXtensiveAspectsWeaver</PostSharp21DependsOn>
  
  <!-- Autodetect root folder -->
  <XtensiveOrmPath Condition="'$(XtensiveOrmPath)'==''">$(MSBuildThisFileDirectory)</XtensiveOrmPath>
  
  <!-- Enable integrated PostSharp unless explicitly disabled by user -->
  <XtensiveOrmIntegratedPostSharp Condition="'$(XtensiveOrmIntegratedPostSharp)'==''">true</XtensiveOrmIntegratedPostSharp>
</PropertyGroup>

<!-- Validate that root path is set optionally triggering detection target -->
<Target Name="ValidateXtensiveOrmPath">
  <Error Condition="'$(XtensiveOrmPath)'==''"
         Text="XtensiveOrmPath property is not set" />
  <Error Condition="!Exists('$(XtensiveOrmPath)')"
         Text="XtensiveOrmPath is set to '$(XtensiveOrmPath)' which does not exists" />
  <PropertyGroup>
    <XtensiveOrmPath Condition="!HasTrailingSlash('$(XtensiveOrmPath)')">$(XtensiveOrmPath)\</XtensiveOrmPath>
  </PropertyGroup>
  <Message Importance="low" Text="Using XtensiveOrmPath = '$(XtensiveOrmPath)'"/>
</Target>

<!-- Add tools folder to PostSharp plugin search path -->
<Target Name="RegisterXtensiveAspectsWeaver" DependsOnTargets="ValidateXtensiveOrmPath">
  <PropertyGroup>
    <XtensiveAspectsWeaverPath>$(XtensiveOrmPath)Tools</XtensiveAspectsWeaverPath>
    <PostSharpSearchPath>$(PostSharpSearchPath);$(XtensiveAspectsWeaverPath)</PostSharpSearchPath>
  </PropertyGroup>
  <Message Importance="low" Text="Added '$(XtensiveAspectsWeaverPath)' to PostSharpSearchPath"/>
</Target>

<!-- Import integrated PostSharp if required -->
<Import Condition="'$(XtensiveOrmIntegratedPostSharp)'=='true'"
        Project="Tools\PostSharp\PostSharp.targets" />

</Project>
