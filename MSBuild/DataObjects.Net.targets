<?xml version="1.0" encoding="utf-8"?>

<!--
  Copyright (C) 2011-2013 Xtensive LLC.
  All rights reserved.
  For conditions of distribution and use, see license.
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

<PropertyGroup>
  <!-- Register weaving target for execution after compilation -->
  <CompileDependsOn>$(CompileDependsOn);XtensiveOrmRunWeaver</CompileDependsOn>
  <!-- Autodetect weaver program unless overridden by user -->
  <XtensiveOrmWeaver Condition="'$(XtensiveOrmWeaver)'==''">$(MSBuildThisFileDirectory)\Tools\Weaver.exe</XtensiveOrmWeaver>
</PropertyGroup>

<!-- Run weaver -->
<Target Name="XtensiveOrmRunWeaver"
        Inputs="@(IntermediateAssembly -> '%(FullPath)')"
        Outputs="@(IntermediateAssembly -> '%(FullPath).weaver-stamp')"
        DependsOnTargets="ResolveAssemblyReferences;_CopyFilesMarkedCopyLocal">
  <Error Condition="!Exists('$(XtensiveOrmWeaver)')"
         Text="Weaver is not found at '$(XtensiveOrmWeaver)'" />
  <Message Importance="low" Text="Using weaver at '$(XtensiveOrmWeaver)'"/>
  <PropertyGroup>
    <XtensiveOrmWeaverArguments>/makeBackup:true /processDebugSymbols:true /writeStampFile:true /input:@(IntermediateAssembly -> '%(FullPath)') @(ReferencePath -> '/reference:"%(FullPath)"', ' ')</XtensiveOrmWeaverArguments>
    <XtensiveOrmWeaverArguments Condition="$(SignAssembly)=='true'">$(XtensiveOrmWeaverArguments) /strongNameKey:$(AssemblyOriginatorKeyFile)</XtensiveOrmWeaverArguments>
  </PropertyGroup>
  <Exec Command="$(XtensiveOrmWeaver) $(XtensiveOrmWeaverArguments)"
        WorkingDirectory="$(MSBuildProjectDirectory)"
        IgnoreExitCode="true">
    <Output TaskParameter="ExitCode" PropertyName="XtensiveOrmWeaverResult" />        
  </Exec>
  <Error
    Condition="'$(XtensiveOrmWeaverResult)'!='0'"
    Text="DataObjects.Net persistence weaving failed." />
</Target>

</Project>
