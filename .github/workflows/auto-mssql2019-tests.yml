name: âš™ðŸ“šðŸ”… Automated MS SQL Server 2019 tests
run-name: Tests on MS SQL Server 2019 tests triggered by '${{ github.event_name }}'. Run No ${{ github.run_number }}.

on:
  push:
    branches:
      - '7.1'
      - '7.1-*'
    paths:
      # containers
      - 'Containers/mssql/do-mssql-2019'
      - 'Containers/mssql/**.sh'
      - 'Containers/mssql/**.sql'
      # extensions code only
      - 'Extensions/**'
      - '!Extensions/**.csproj'
      - '!Extensions/**.md'
      - '!Extensions/**.props'
      - '!Extensions/**.snk'
      #main project
      - 'Orm/Xtensive.Orm/**'
      - '!Orm/Xtensive.Orm/**.csproj'
      # provider
      - 'Orm/Xtensive.Orm.SqlServer/**'
      - '!Orm/Xtensive.Orm.SqlServer/**.csproj'
      - '!Orm/Xtensive.Orm.SqlServer/NuGetContent/**'
      # tests framework
      - 'Orm/Xtensive.Orm.Framework/**'
      - '!Orm/Xtensive.Orm.Framework/**.csproj'
      # main test project - any code change
      - 'Orm/Xtensive.Orm.Tests/**'
      - '!Orm/Xtensive.Orm.Tests/**.csproj'
      # sql tests - general and provider-specific
      - 'Orm/Xtensive.Orm.Tests.Sql/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Firebird/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/MySQL/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Oracle/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/PosgreSql/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Sqlite/**'
      #- '!Orm/Xtensive.Orm.Tests.Sql/SqlServer/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/SqlServerCe/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/**.csproj'
      # weaver changes
      - 'Weaver/**'
      # ability to trigger on demand
      - 'TestFileForBuildServerTests.txt'

  pull_request:
    branches:
      - '7.1'
    paths:
      # containers
      - 'Containers/mssql/do-mssql-2019'
      - 'Containers/mssql/**.sh'
      - 'Containers/mssql/**.sql'
      # extensions code only
      - 'Extensions/**'
      - '!Extensions/**.csproj'
      - '!Extensions/**.md'
      - '!Extensions/**.props'
      - '!Extensions/**.snk'
      #main project
      - 'Orm/Xtensive.Orm/**'
      - '!Orm/Xtensive.Orm/**.csproj'
      # provider
      - 'Orm/Xtensive.Orm.SqlServer/**'
      - '!Orm/Xtensive.Orm.SqlServer/**.csproj'
      - '!Orm/Xtensive.Orm.SqlServer/NuGetContent/**'
      # tests framework
      - 'Orm/Xtensive.Orm.Framework/**'
      - '!Orm/Xtensive.Orm.Framework/**.csproj'
      # main test project - any code change
      - 'Orm/Xtensive.Orm.Tests/**'
      - '!Orm/Xtensive.Orm.Tests/**.csproj'
      # sql tests - general and provider-specific
      - 'Orm/Xtensive.Orm.Tests.Sql/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Firebird/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/MySQL/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Oracle/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/PosgreSql/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Sqlite/**'
      #- '!Orm/Xtensive.Orm.Tests.Sql/SqlServer/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/SqlServerCe/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/**.csproj'
      # weaver changes
      - 'Weaver/**'
      # ability to trigger on demand
      - 'TestFileForBuildServerTests.txt'

  pull_request_review:
    branches:
      - '7.1'
    paths:
      # containers
      - 'Containers/mssql/do-mssql-2019'
      - 'Containers/mssql/**.sh'
      - 'Containers/mssql/**.sql'
      # extensions code only
      - 'Extensions/**'
      - '!Extensions/**.csproj'
      - '!Extensions/**.md'
      - '!Extensions/**.props'
      - '!Extensions/**.snk'
      #main project
      - 'Orm/Xtensive.Orm/**'
      - '!Orm/Xtensive.Orm/**.csproj'
      # provider
      - 'Orm/Xtensive.Orm.SqlServer/**'
      - '!Orm/Xtensive.Orm.SqlServer/**.csproj'
      - '!Orm/Xtensive.Orm.SqlServer/NuGetContent/**'
      # tests framework
      - 'Orm/Xtensive.Orm.Framework/**'
      - '!Orm/Xtensive.Orm.Framework/**.csproj'
      # main test project - any code change
      - 'Orm/Xtensive.Orm.Tests/**'
      - '!Orm/Xtensive.Orm.Tests/**.csproj'
      # sql tests - general and provider-specific
      - 'Orm/Xtensive.Orm.Tests.Sql/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Firebird/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/MySQL/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Oracle/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/PosgreSql/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/Sqlite/**'
      #- '!Orm/Xtensive.Orm.Tests.Sql/SqlServer/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/SqlServerCe/**'
      - '!Orm/Xtensive.Orm.Tests.Sql/**.csproj'
      # weaver changes
      - 'Weaver/**'
      # ability to trigger on demand
      - 'TestFileForBuildServerTests.txt'

# new commits with the same key will cancel previously run workflows
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  test_on_mssql2019:
    name: Tests on MS SQL Server 2019
    strategy:
      matrix:
        net: [ 'net5.0', 'net6.0' ]
    # For security reasons we allow test runs either for pushes from the team or for pull-requests after their changes were seen and approved by someone
    #
    # push filter - to cover pushes from the team to main branch of major version
    # first 'pull_request_review' filter - to cover external pull-requests, since there are major security concerns about content of pull-request we cannot allow auto-runs of tests
    # second 'pull_request_review' - to cover internal pull-requests that were not covered by 'on push' trigger
    #
    if: |
      github.event_name == 'push'
        || (github.event_name == 'pull_request_review'
             && github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
             && startsWith(github.event.pull_request.base.ref, '7.1')
             && github.event.review.state == 'approved')
        || (github.event_name == 'pull_request'
             && github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name
             && !startsWith(github.head_ref, '7.1-'))
    uses: DataObjects-NET/dataobjects-net/.github/workflows/reusable-storage-dependant-tests.yml@7.1
    with:
      storage: mssql2019
      build_config: Release
      target_framework: ${{ matrix.net }}
      test_output_verbosity: minimal
      test_run_timeout: 50
      run_main: true
      run_sql: true
      run_extensions: true
      publish_raw_results: false